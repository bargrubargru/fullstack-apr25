var resizePlayerOnScroll = (function ($, win, doc) {

    $(doc).on('play-state.html5', function (e, action, playerObj) {
        if (action == "onReady") {
            console.log("play-state.html5", playerObj.container);
            if (playerObj.container.closest(".article-header.video")) {
                init();
                $(doc).off('play-state.html5');
            }
        }
    });

    function init() {
        // global var to let know if we closed or not the small video
        // we start with the small video close and set to true
        var close_resize = true;
        var $player = $("section.article-header.video .player-outer");
        var $wrapper = $('section.article-header.video .player-wrap');

        if (screen.width >= 1280 && $player.length > 0) {
            $("section.article-header").addClass("videoResize");
        }


        // check if the win size is bigger or equal to 1280
        if (screen.width >= 1280 && $player.length > 0) {

            //console.log("screen.width >= 1280");

            //adding close button to the video container and hide it
            $player.prepend('<div id="resize-close-button"></div><div id="resize-close-button-hover"></div>');
            $('#resize-close-button').css("opacity", "0");

            //Define the bottom size of the resized video by video ratio type 
            var bottom_size = '6';
            if ($player.hasClass("s_16x9")) {
                bottom_size = '1';
                //console.log("bottom_size");
            }


            //What happen if we click on the close button
            $('#resize-close-button-hover').click(function () {

                //we set close_resize to false
                close_resize = false;
                //we pousing the video
                $("video", $player).get(0).pause();
                // we hide the close button
                $('#resize-close-button').css("opacity", "0");
                // hide the whole video container
                $player.css("opacity", "0");
                //we calc the bottom position of the origin place
                var bottom = $wrapper.offset().top + ($player.outerHeight() - $('body').scrollTop());
                $(".flash_player", $player).css('cssText', 'width:' + width + 'px;height:' + height + 'px;');
                // we move the video to it's origin place
                $player.css('cssText', 'width:' + width + 'px;height:' + height + 'px;bottom:' + Math.ceil(bottom) + 'px !important;right:' + Math.ceil(right) + 'px !important;');
                // adding the static position as defined in default
                $player.addClass('up');
                // removing the fix class of the right cottom corner
                $player.removeClass('fixed');
                // show the video div
                $(".flash_player", $player).show();
                $(".html5_player")[0].player._pause();
            });




            // Define positions
            var right = $('body').width() - $player.width() - $player.offset().left;
            var bottom = $wrapper.offset().top + $player.outerHeight();
            var height = $player.css('height').replace("px", "");
            var width = $player.css('width').replace("px", "");


            //update the video position		
            var checkVideoPos = $wrapper.get(0).getBoundingClientRect().top;

            // Initiate the position of the first place of video
            $player.css('cssText', 'width:' + width + 'px;height:' + height + 'px;bottom:' + Math.ceil(bottom) + 'px !important;right:' + Math.ceil(right) + 'px !important;-webkit-transition: all .4s ease;');

            $wrapper.css("height", height + 'px');

            $player.find(".controls_holder .bottom .right").click(function () {
                $("iframe", $player).css('opacity', '1');
            });

            var screen_change_events = "webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange";

            // check if we close full screen
            $(doc).on(screen_change_events, function () {
                // we calc the new bottom position
                if ($wrapper.find('.html5_player').length == 1) {
                    if (checkVideoPos < -300) {
                        // hide the right bottom corner ad
                        $("div[id *= 'ZA_CAMP']").hide();
                        $player.css('cssText', 'width:304px;height:186px;bottom:' + bottom_size + 'vw;right:1vw;-webkit-transition: all 0.4s ease; ');
                        $('iframe', $player).css('opacity', '1');
                        $('video', $player).css('opacity', '1');
                    }
                }
            });

            var animationLimit = ($wrapper.height() / 3 * 2);
            // look for scrool event
            win.addEventListener("scroll", function () {
                //console.log("scroll");
                checkVideoPos = $wrapper.get(0).getBoundingClientRect().top;


                // if the scrolling is under the video position we resize the video and bring it to the right bottom corner
                if (checkVideoPos < -(animationLimit)) {



                    //we create the transform only if the video is running and it it's not closed
                    if (close_resize === true && (!$("video", $player).get(0).paused || !$(".html5_player")[0].player._paused)) {


                        if (!($('.player-outer.fixed .html5_player.full_screen').length)) {
                            $('video', $player).css('opacity', '0');
                            $('iframe', $player).css('opacity', '0');

                        }

                        $player.addClass('fixed');
                        $('.html5_player', $player).removeClass('info share_buttons');
                        $player.removeClass('up');


                        $player.css('cssText', 'width:304px;height:186px;bottom:' + bottom_size + 'vh;right:1vw;-webkit-transition: all 0.4s ease; ');
                        close_resize = false;


                        // we wait until the animation of small size end
                        $player.one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend", function () {

                            if (checkVideoPos < -(animationLimit)) {

                                // hide the right bottom corner ad
                                $('body').addClass("resizeEnable");
                                //enable to show the left x bottom corner ad
                                $('body').removeClass("xDisable");
                                // we trigger a mousemove to fix ad position
                                $('video', $player).trigger("mousemove");

                                // we return to movie from black screen
                                $('video', $player).css('opacity', '1');
                                $('iframe', $player).css('opacity', '1');


                                // check if to show the close button on enter close button area			
                                $('.player-outer.fixed #resize-close-button').mouseenter(function () {

                                    $('#resize-close-button').css('cssText', 'background-repeat: no-repeat;opacity: 1;width: 340px;height: 263px;margin-top: -35px;position: absolute;cursor: pointer !important;');
                                    $('#resize-close-button-hover').css('cssText', 'opacity:1;background: url(' + staticResourcesUriPrefix + '/images/neo/article/resize_close_button.png);background-repeat: no-repeat;opacity: 1;width: 35px;height: 35px;margin-top: -35px;position: absolute;cursor: pointer !important;');

                                });

                                // check if to show the close button on enter iframe area
                                $('.player-outer.fixed iframe').mouseenter(function () {
                                    if ($('.player-outer.fixed').length) {
                                        $('#resize-close-button').css('cssText', 'background-repeat: no-repeat;opacity: 1;width: 340px;height: 263px;margin-top: -35px;position: absolute;cursor: pointer !important;');
                                        $('#resize-close-button-hover').css('cssText', 'opacity:1;background: url(' + staticResourcesUriPrefix + '/images/neo/article/resize_close_button.png);background-repeat: no-repeat;opacity: 1;width: 35px;height: 35px;margin-top: -35px;position: absolute;cursor: pointer !important;');
                                    }
                                });

                                // check if to show the close button on enter video area
                                $('.player-outer.fixed video').mouseenter(function () {
                                    if ($('.player-outer.fixed').length) {
                                        $(this).css('cssText', 'cursor: pointer');
                                        $('#resize-close-button').css('cssText', 'background-repeat: no-repeat;opacity: 1;width: 340px;height: 263px;margin-top: -35px;position: absolute;cursor: pointer !important;');
                                        $('#resize-close-button-hover').css('cssText', 'opacity:1;background: url(' + staticResourcesUriPrefix + '/images/neo/article/resize_close_button.png);background-repeat: no-repeat;opacity: 1;width: 35px;height: 35px;margin-top: -35px;position: absolute;cursor: pointer !important;');
                                    }
                                });

                                // check if to show the close button on enter close button hover
                                $('.player-outer.fixed #resize-close-button-hover').mouseenter(function () {
                                    if ($('.player-outer.fixed').length) {
                                        $('#resize-close-button-hover').css('cssText', 'opacity:1;background: url(' + staticResourcesUriPrefix + '/images/neo/article/resize_close_button.png);background-repeat: no-repeat;opacity: 1;width: 35px;height: 35px;margin-top: -35px;position: absolute;cursor: pointer !important;background-position-y: -38px;cursor: pointer !important;');
                                    }
                                });

                                // check if to show the close button on leave close button hover
                                $('.player-outer.fixed #resize-close-button-hover').mouseleave(function () {
                                    if ($('.player-outer.fixed').length) {
                                        $('#resize-close-button-hover').css('cssText', 'opacity:0;');
                                    }
                                });

                                // check if to show the close button on leave close button
                                $('.player-outer.fixed #resize-close-button').mouseleave(function () {
                                    if ($('.player-outer.fixed').length) {
                                        $('#resize-close-button-hover').css('cssText', 'opacity:0;');
                                    }
                                });

                            }
                        });
                    }
                } else {

                    // hide the close button
                    $('#resize-close-button').hide();
                    $('#resize-close-button-hover').hide();
                    // we create the back animation
                    var bottom = win.innerHeight - $wrapper.get(0).getBoundingClientRect().bottom;

                    // we create the back animation

                    $player.css('cssText', 'width:' + width + 'px;height:' + height + 'px;bottom:' + Math.ceil(bottom) + 'px !important;right:' + Math.ceil(right) + 'px !important;-webkit-transition: all .4s ease;');

                    // hide the left x bottom corner ad
                    $('body').addClass("xDisable");


                    // we black hte screen in the animation
                    if (close_resize === false) {

                        if (!$('.player-outer.fixed .html5_player.full_screen').length) {
                            $('video', $player).css('opacity', '0');
                            $('iframe', $player).css('opacity', '0');

                        }
                        close_resize = true;
                    }

                    // we wait until the animation end and then we show the video, trigger the movie mouse move (because of ads position problem)
                    // we hide the colse button
                    $player.one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend", function () {

                        var checkVideoPos = $wrapper.get(0).getBoundingClientRect().top;
                        if (checkVideoPos >= -(animationLimit)) {

                            $('video', $player).css('opacity', '1');
                            $('iframe', $player).css('opacity', '1');
                            $player.addClass('up');
                            $player.removeClass('fixed');
                            close_resize = true;
                            $('video', $player).trigger("mousemove");
                            // show back the right bottom corner ad
                            $('body').removeClass("resizeEnable");
                        }
                    });
                }
            }, false);
        }
    }
    return {
        init: init
    };
})(jQuery, window, document);
